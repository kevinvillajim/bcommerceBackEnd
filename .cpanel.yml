---
deployment:
  tasks:
    # Variables de rutas
    - export REPOPATH=/home/capacit3/repositories/bcommerceBackEnd
    - export DEPLOYPATH=/home/capacit3/public_html/api
    
    # Ir al directorio del repositorio
    - cd $REPOPATH
    
    # ðŸ”’ SISTEMA INTELIGENTE DE BACKUP (mÃ¡ximo 3)
    - |
      if [ -d "$REPOPATH/storage/app/public" ]; then
        # Eliminar backups antiguos (mantener solo los 2 mÃ¡s recientes)
        ls -dt $REPOPATH/storage_backup_* 2>/dev/null | tail -n +3 | xargs rm -rf 2>/dev/null || true
        
        # Crear nuevo backup
        cp -r $REPOPATH/storage/app/public $REPOPATH/storage_backup_$(date +%Y%m%d_%H%M%S)
        echo "âœ… Backup de storage creado (mÃ¡ximo 3 backups mantenidos)"
      fi
    
    # Instalar/actualizar dependencias de Composer (sin dev dependencies)
    - composer install --no-dev --optimize-autoloader --no-interaction
    
    # ðŸ”’ PROTEGER STORAGE: Solo crear estructura si NO existe
    - mkdir -p $REPOPATH/storage/app/public/avatars 2>/dev/null || true
    - mkdir -p $REPOPATH/storage/app/public/products 2>/dev/null || true  
    - mkdir -p $REPOPATH/storage/app/public/orders 2>/dev/null || true
    - mkdir -p $REPOPATH/storage/logs 2>/dev/null || true
    - mkdir -p $REPOPATH/storage/framework/cache 2>/dev/null || true
    - mkdir -p $REPOPATH/storage/framework/sessions 2>/dev/null || true
    - mkdir -p $REPOPATH/storage/framework/views 2>/dev/null || true
    
    # Permisos correctos para storage (sin tocar contenido)
    - chmod -R 775 $REPOPATH/storage/ 2>/dev/null || true
    - chmod -R 755 $REPOPATH/storage/logs/ 2>/dev/null || true
    
    # Solo generar clave si NO existe
    - php $REPOPATH/artisan key:generate --no-interaction --show > /dev/null 2>&1 || php $REPOPATH/artisan key:generate --no-interaction || true
    
    # Crear enlace simbÃ³lico para storage pÃºblico (force para sobrescribir si es necesario)
    - php $REPOPATH/artisan storage:link --force 2>/dev/null || true
    
    # ðŸ”’ LIMPIAR CACHE SIN TOCAR DATOS
    - php $REPOPATH/artisan config:clear
    - php $REPOPATH/artisan cache:clear
    - php $REPOPATH/artisan route:clear
    - php $REPOPATH/artisan view:clear
    
    # ðŸ—ƒï¸ MIGRACIONES (solo si hay nuevas - NO borra datos)
    - php $REPOPATH/artisan migrate --force --no-interaction || echo "No migrations needed"
    
    # Cachear configuraciÃ³n para mejor rendimiento
    - php $REPOPATH/artisan config:cache
    - php $REPOPATH/artisan route:cache
    
    # ðŸŒ DEPLOYMENT A DIRECTORIO WEB
    - mkdir -p $DEPLOYPATH
    
    # Copiar archivos pÃºblicos de Laravel (incluyendo .htaccess que ya estÃ¡ en Git)
    - /bin/cp -R $REPOPATH/public/* $DEPLOYPATH/
    
    # Permisos finales
    - chmod -R 755 $DEPLOYPATH
    - chmod 644 $DEPLOYPATH/.htaccess
    
    # ðŸ“Š VERIFICACIÃ“N FINAL (logs para debugging)
    - echo "âœ… Deployment completed at $(date)"
    - echo "ðŸ“ Storage backups:" && ls -la $REPOPATH/storage_backup_* 2>/dev/null | wc -l && echo " backups maintained" || echo "No backups found"
    - echo "ðŸ”— Storage link:" && ls -la $REPOPATH/public/storage 2>/dev/null || echo "Storage link not found"